# =============================================
# ScreenCloud Order Management System
# CI Pipeline - Quality Gates
# =============================================
#
# This workflow ensures code quality before deployment:
# 1. Lint - Code style and best practices
# 2. Type Check - TypeScript compilation
# 3. Test - Unit and integration tests with PostgreSQL
# 4. Build - Verify both apps compile successfully
#
# Deployment Strategy:
# - Railway (API) and Vercel (Frontend) auto-deploy on push to main
# - This CI pipeline runs in parallel as a quality gate
# - If CI fails, you should investigate before the auto-deploy completes
#
# For production, you would disable auto-deploy and add deploy jobs here.

name: CI Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================
  # Quality Checks (runs on all PRs and pushes)
  # ============================================
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter api exec prisma generate
        env:
          # Dummy URL for prisma generate (no actual DB connection needed)
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: Lint
        run: pnpm run lint

      - name: Type check
        run: pnpm run typecheck

  # ============================================
  # Tests (runs on all PRs and pushes)
  # ============================================
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: oms_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter api exec prisma generate
        env:
          # Dummy URL for prisma generate (no actual DB connection needed)
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: Run database migrations
        run: pnpm --filter api exec prisma migrate deploy
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/oms_test

      - name: Seed test database
        run: pnpm --filter api exec prisma db seed
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/oms_test

      - name: Run tests
        run: pnpm --filter api test
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/oms_test
          TEST_DATABASE_URL: postgresql://test:test@localhost:5432/oms_test
          NODE_ENV: test

  # ============================================
  # Build Check (ensures both apps build)
  # ============================================
  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [quality]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter api exec prisma generate
        env:
          # Dummy URL for prisma generate (no actual DB connection needed)
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: Build API
        run: pnpm --filter api build

      - name: Build Web
        run: pnpm --filter web build
        env:
          VITE_API_URL: https://placeholder.railway.app/graphql

  # ============================================
  # Deployment Note
  # ============================================
  # Deployment is handled by platform auto-deploy:
  # - Railway: Auto-deploys API on push to main
  # - Vercel: Auto-deploys Frontend on push to main
  #
  # This CI pipeline runs in parallel as a quality gate.
  # If you need CI-controlled deployment, uncomment the jobs below
  # and configure these GitHub Secrets:
  # - RAILWAY_TOKEN
  # - VERCEL_TOKEN
  # - VERCEL_ORG_ID
  # - VERCEL_PROJECT_ID
  # - PRODUCTION_API_URL
